<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>wau - wayland on lua</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>wau</h1>


<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Examples</h2>
<ul class="nowrap">
  <li><a href="../examples/foreign_toplevel_manager.lua.html">foreign_toplevel_manager.lua</a></li>
  <li><a href="../examples/layershell.lua.html">layershell.lua</a></li>
  <li><a href="../examples/list_globals.lua.html">list_globals.lua</a></li>
  <li><strong>toplevel.lua</strong></li>
  <li><a href="../examples/xdg_top.lua.html">xdg_top.lua</a></li>
</ul>
<h2>Protocols</h2>
<ul class="nowrap">
  <li><a href="../protocols/wayland.html">wayland</a></li>
</ul>
<h2>Classes</h2>
<ul class="nowrap">
  <li><a href="../classes/wl_display.html">wl_display</a></li>
  <li><a href="../classes/wl_interface.html">wl_interface</a></li>
  <li><a href="../classes/wl_proxy.html">wl_proxy</a></li>
  <li><a href="../classes/wl_cursor.html">wl_cursor</a></li>
  <li><a href="../classes/wl_cursor_image.html">wl_cursor_image</a></li>
  <li><a href="../classes/wl_cursor_theme.html">wl_cursor_theme</a></li>
</ul>
<h2>Manual</h2>
<ul class="nowrap">
  <li><a href="../manual/README.md.html">README</a></li>
  <li><a href="../manual/coming-from-c.md.html">coming-from-c</a></li>
  <li><a href="../manual/overview.md.html">overview</a></li>
  <li><a href="../manual/scanner.md.html">scanner</a></li>
</ul>

</div>

<div id="content">

    <h2>toplevel.lua</h2>
<pre>
<span class="comment">-- a minimal exmaple of using xdg-shell for creating a toplevel window with wau
</span>
<span class="keyword">local</span> wau = <span class="global">require</span>(<span class="string">"wau"</span>)
wau:<span class="global">require</span>(<span class="string">"protocol.xdg-shell"</span>)

<span class="comment">-- something we will need later
</span>
<span class="keyword">local</span> helpers = <span class="global">require</span>(<span class="string">"helpers"</span>) <span class="comment">-- helpers.so should be built already
</span><span class="keyword">local</span> lgi = <span class="global">require</span>(<span class="string">"lgi"</span>)
<span class="keyword">local</span> GLib = lgi.GLib
<span class="keyword">local</span> cairo = lgi.cairo

<span class="comment">-- connect + basic vars
</span>
<span class="keyword">local</span> display = wau.wl_display.<span class="function-name">connect</span>()
<span class="keyword">local</span> registry = display:<span class="function-name">get_registry</span>()

<span class="keyword">local</span> width = <span class="number">200</span>
<span class="keyword">local</span> height = <span class="number">200</span>
<span class="keyword">local</span> stride = width * <span class="number">4</span>
<span class="keyword">local</span> size = stride * height

<span class="comment">-- registering globals; the usual stuff
</span>
<span class="keyword">local</span> comp, seat, shm, xdg, output
registry:<span class="function-name">add_listener</span> {
    [<span class="string">"global"</span>] = <span class="keyword">function</span>(_, name, interface, version)
        <span class="keyword">if</span> interface == <span class="string">"wl_output"</span> <span class="keyword">then</span>
            output = registry:<span class="function-name">bind</span>(name, wau.wl_output, version)
        <span class="keyword">elseif</span> interface == <span class="string">"wl_compositor"</span> <span class="keyword">then</span>
            comp = registry:<span class="function-name">bind</span>(name, wau.wl_compositor, version)
        <span class="keyword">elseif</span> interface == <span class="string">"wl_shm"</span> <span class="keyword">then</span>
            shm = registry:<span class="function-name">bind</span>(name, wau.wl_shm, version)
        <span class="keyword">elseif</span> interface == <span class="string">"wl_seat"</span> <span class="keyword">then</span>
            seat = registry:<span class="function-name">bind</span>(name, wau.wl_seat, version)
        <span class="keyword">elseif</span> interface == <span class="string">"xdg_wm_base"</span> <span class="keyword">then</span>
            xdg = registry:<span class="function-name">bind</span>(name, wau.xdg_wm_base, version)
        <span class="keyword">end</span>
    <span class="keyword">end</span>
}
display:<span class="function-name">roundtrip</span>()
<span class="global">assert</span>(comp <span class="keyword">and</span> shm <span class="keyword">and</span> seat <span class="keyword">and</span> output <span class="keyword">and</span> xdg, <span class="string">"Couldn't load globals"</span>)

<span class="comment">-- a dumb example of handeling input
</span>
<span class="keyword">local</span> pointer_listener = {
    [<span class="string">"motion"</span>] = <span class="keyword">function</span>(...) <span class="global">print</span>(<span class="string">"pointer move"</span>, ...) <span class="keyword">end</span>,
    [<span class="string">"button"</span>] = <span class="keyword">function</span>(...) <span class="global">print</span>(<span class="string">"pointer click"</span>, ...) <span class="keyword">end</span>,
}

<span class="keyword">local</span> kb_listener = {
    [<span class="string">"key"</span>] = <span class="keyword">function</span>(...) <span class="global">print</span>(<span class="string">"key"</span>, ...) <span class="keyword">end</span>
}

seat:<span class="function-name">add_listener</span> {
    [<span class="string">"capabilities"</span>] = <span class="keyword">function</span>(_, c)
        <span class="keyword">if</span> c &amp; wau.wl_seat.Capability.POINTER ~= <span class="number">0</span> <span class="keyword">then</span>
            <span class="keyword">local</span> pointer = seat:<span class="function-name">get_pointer</span>()
            pointer:<span class="function-name">add_listener</span>(pointer_listener)
        <span class="keyword">end</span>
        <span class="keyword">if</span> c &amp; wau.wl_seat.Capability.KEYBOARD ~= <span class="number">0</span> <span class="keyword">then</span>
            <span class="keyword">local</span> keyboard = seat:<span class="function-name">get_keyboard</span>()
            keyboard:<span class="function-name">add_listener</span>(kb_listener)
        <span class="keyword">end</span>
    <span class="keyword">end</span>
}

<span class="comment">-- getting our dummy buffer
</span>
<span class="keyword">local</span> <span class="keyword">function</span> <span class="function-name">get_buffer</span>()
    <span class="keyword">local</span> fd, data = helpers.<span class="function-name">allocate_shm</span>(size)
    <span class="keyword">local</span> mypool = shm:<span class="function-name">create_pool</span>(fd, size)
    <span class="keyword">local</span> mybuffer = mypool:<span class="function-name">create_buffer</span>(<span class="number">0</span>, width, height, stride, <span class="number">0</span>)
    <span class="keyword">local</span> cairo_surface = cairo.ImageSurface.<span class="function-name">create_for_data</span>(data,
        cairo.Format.ARGB32, width, height, <span class="number">4</span> * width)
    <span class="keyword">local</span> cr = cairo.<span class="function-name">Context</span>(cairo_surface)
    cr:<span class="function-name">set_source_rgba</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.6</span>)
    cr:<span class="function-name">paint</span>()
    <span class="keyword">return</span> mybuffer
<span class="keyword">end</span>

<span class="comment">-- setting up the window
</span>
xdg:<span class="function-name">add_listener</span> { [<span class="string">"ping"</span>] = wau.xdg_wm_base.pong }

<span class="keyword">local</span> surface = comp:<span class="function-name">create_surface</span>()
<span class="keyword">local</span> xdg_surface = xdg:<span class="function-name">get_xdg_surface</span>(surface)

xdg_surface:<span class="function-name">add_listener</span> {
    [<span class="string">"configure"</span>] = <span class="keyword">function</span>(_, s)
        xdg_surface:<span class="function-name">ack_configure</span>(s)
        <span class="keyword">local</span> mybuffer = <span class="function-name">get_buffer</span>()
        surface:<span class="function-name">attach</span>(mybuffer, <span class="number">0</span>, <span class="number">0</span>)
        surface:<span class="function-name">commit</span>()
    <span class="keyword">end</span>
}

<span class="keyword">local</span> xdg_toplevel = xdg_surface:<span class="function-name">get_toplevel</span>()
xdg_toplevel:<span class="function-name">set_title</span>(<span class="string">"üê∂ wau"</span>)
            :<span class="function-name">set_app_id</span>(<span class="string">"superwichtig"</span>)

surface:<span class="function-name">commit</span>()

<span class="comment">-- a more sane example of an actual mainloop, no <code>while true</code>
</span>
GLib.<span class="function-name">timeout_add</span>(GLib.PRIORITY_DEFAULT, <span class="number">20</span>, <span class="keyword">function</span>()
    display:<span class="function-name">roundtrip</span>()
    <span class="keyword">return</span> <span class="keyword">true</span>
<span class="keyword">end</span>)


<span class="keyword">local</span> mainloop = GLib.<span class="function-name">MainLoop</span>(<span class="keyword">nil</span>, <span class="keyword">nil</span>)
mainloop:<span class="function-name">run</span>()</pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/lunarmodules/LDoc">LDoc 1.5.0</a></i>
<i style="float:right;">Last updated 2023-05-22 19:13:31 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
