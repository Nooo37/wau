<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>wau - wayland on lua</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>wau</h1>


<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Examples</h2>
<ul class="nowrap">
  <li><a href="../examples/foreign_toplevel_manager.lua.html">foreign_toplevel_manager.lua</a></li>
  <li><strong>layershell.lua</strong></li>
  <li><a href="../examples/list_globals.lua.html">list_globals.lua</a></li>
  <li><a href="../examples/toplevel.lua.html">toplevel.lua</a></li>
  <li><a href="../examples/xdg_top.lua.html">xdg_top.lua</a></li>
</ul>
<h2>Protocols</h2>
<ul class="nowrap">
  <li><a href="../protocols/wayland.html">wayland</a></li>
</ul>
<h2>Classes</h2>
<ul class="nowrap">
  <li><a href="../classes/wl_display.html">wl_display</a></li>
  <li><a href="../classes/wl_interface.html">wl_interface</a></li>
  <li><a href="../classes/wl_proxy.html">wl_proxy</a></li>
  <li><a href="../classes/wl_cursor.html">wl_cursor</a></li>
  <li><a href="../classes/wl_cursor_image.html">wl_cursor_image</a></li>
  <li><a href="../classes/wl_cursor_theme.html">wl_cursor_theme</a></li>
</ul>
<h2>Manual</h2>
<ul class="nowrap">
  <li><a href="../manual/README.md.html">README</a></li>
  <li><a href="../manual/coming-from-c.md.html">coming-from-c</a></li>
  <li><a href="../manual/overview.md.html">overview</a></li>
  <li><a href="../manual/scanner.md.html">scanner</a></li>
</ul>

</div>

<div id="content">

    <h2>layershell.lua</h2>
<pre>
<span class="comment">--- a simple layershell example
</span>
<span class="comment">-- loading protocols
</span>
<span class="keyword">local</span> wau = <span class="global">require</span>(<span class="string">"wau"</span>)
wau:<span class="global">require</span>(<span class="string">"protocol.xdg-shell"</span>) <span class="comment">-- layershell implicitly depends on xdg-shell
</span>wau:<span class="global">require</span>(<span class="string">"protocol.wlr-layer-shell-unstable-v1"</span>)

<span class="comment">-- something we need later on
</span>
<span class="keyword">local</span> helpers = <span class="global">require</span>(<span class="string">"helpers"</span>) <span class="comment">-- helpers.so should be built already
</span><span class="keyword">local</span> lgi = <span class="global">require</span>(<span class="string">"lgi"</span>)
<span class="keyword">local</span> cairo = lgi.cairo

<span class="comment">-- connecting to the server
</span>
<span class="keyword">local</span> display = wau.wl_display.<span class="function-name">connect</span>()
<span class="global">assert</span>(display, <span class="string">"Couldn't connect to the wayland server"</span>)

<span class="comment">-- register globals
</span>
<span class="keyword">local</span> registry = display:<span class="function-name">get_registry</span>()
<span class="keyword">local</span> output, comp, shm, layershell

registry:<span class="function-name">add_listener</span> {
    [<span class="string">"global"</span>] = <span class="keyword">function</span>(_, name, interface, version)
        <span class="keyword">if</span> interface == <span class="string">"wl_output"</span> <span class="keyword">then</span>
            output = registry:<span class="function-name">bind</span>(name, wau.wl_output, version)
        <span class="keyword">elseif</span> interface == <span class="string">"wl_compositor"</span> <span class="keyword">then</span>
            comp = registry:<span class="function-name">bind</span>(name, wau.wl_compositor, version)
        <span class="keyword">elseif</span> interface == <span class="string">"wl_shm"</span> <span class="keyword">then</span>
            shm = registry:<span class="function-name">bind</span>(name, wau.wl_shm, version)
        <span class="keyword">elseif</span> interface == <span class="string">"zwlr_layer_shell_v1"</span> <span class="keyword">then</span>
            layershell = registry:<span class="function-name">bind</span>(name, wau.zwlr_layer_shell_v1, version)
        <span class="keyword">end</span>
    <span class="keyword">end</span>
}

display:<span class="function-name">roundtrip</span>()
<span class="global">assert</span>(output <span class="keyword">and</span> comp <span class="keyword">and</span> shm, <span class="string">"Couldn't load wl_ output, compositor or shm"</span>)
<span class="global">assert</span>(layershell, <span class="string">"Couldn't load layershell"</span>)

<span class="comment">-- create the wl_surface and the layer shell surface
</span>
<span class="keyword">local</span> width = <span class="number">100</span>
<span class="keyword">local</span> height = <span class="number">100</span>
<span class="keyword">local</span> stride = width * <span class="number">4</span>
<span class="keyword">local</span> size = stride * height

<span class="keyword">local</span> surface = comp:<span class="function-name">create_surface</span>()
display:<span class="function-name">roundtrip</span>()

<span class="keyword">local</span> mywidget = layershell:<span class="function-name">get_layer_surface</span>(surface, output,
    wau.zwlr_layer_shell_v1.Layer.TOP, <span class="string">"epicwau"</span>)

<span class="keyword">local</span> Anchor = wau.zwlr_layer_surface_v1.Anchor
mywidget:<span class="function-name">set_anchor</span>(Anchor.RIGHT + Anchor.TOP)
        :<span class="function-name">set_margin</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>)
        :<span class="function-name">set_size</span>(width, height)
        :<span class="function-name">add_listener</span> { [<span class="string">"configure"</span>] = wau.zwlr_layer_surface_v1.ack_configure }
        <span class="comment">-- Same thing as doing this:
</span>        <span class="comment">--:add_listener { ["configure"] = function(self, s) self:ack_configure(s) end }
</span>
surface:<span class="function-name">commit</span>()
display:<span class="function-name">roundtrip</span>()

<span class="comment">-- now that we got a surface, we need a buffer to attach to the surface
</span>
<span class="keyword">local</span> fd, data = helpers.<span class="function-name">allocate_shm</span>(size)
<span class="keyword">local</span> mypool = shm:<span class="function-name">create_pool</span>(fd, size)
<span class="keyword">local</span> mybuffer = mypool:<span class="function-name">create_buffer</span>(<span class="number">0</span>, width, height, stride, <span class="number">0</span>)
surface:<span class="function-name">attach</span>(mybuffer, <span class="number">0</span>, <span class="number">0</span>)
surface:<span class="function-name">commit</span>()

<span class="comment">-- and finally we need something to draw on the buffer
</span>
<span class="keyword">local</span> cairo_surface = cairo.ImageSurface.<span class="function-name">create_for_data</span>(data,
    cairo.Format.ARGB32, width, height, <span class="number">4</span> * width)
<span class="keyword">local</span> cr = cairo.<span class="function-name">Context</span>(cairo_surface)
cr:<span class="function-name">set_source_rgba</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.6</span>)
cr:<span class="function-name">paint</span>()

<span class="comment">-- no surfaces were harmed during the making of this example
</span>
surface:<span class="function-name">damage</span>(<span class="number">0</span>, <span class="number">0</span>, width, height)
surface:<span class="function-name">commit</span>()
display:<span class="function-name">roundtrip</span>()

<span class="comment">-- our widget doesn't do anything so we can just sleep now
</span>
<span class="global">os</span>.<span class="function-name">execute</span>(<span class="string">"sleep "</span> .. <span class="global">tostring</span>(<span class="number">1000</span> * <span class="number">2</span>))</pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/lunarmodules/LDoc">LDoc 1.5.0</a></i>
<i style="float:right;">Last updated 2023-05-22 19:13:31 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
