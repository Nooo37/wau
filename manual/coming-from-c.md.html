<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>wau - wayland on lua</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>wau</h1>


<ul>
  <li><a href="../index.html">Index</a></li>
</ul>

<h2>Contents</h2>
<ul>
<li><a href="#1__Lua_can_emulate_object_oriented_programming">1. Lua can emulate object-oriented programming </a></li>
<li><a href="#2__Lua_is_more_forgiving">2. Lua is more forgiving </a></li>
</ul>


<h2>Manual</h2>
<ul class="nowrap">
  <li><a href="../manual/README.md.html">README</a></li>
  <li><strong>coming-from-c</strong></li>
  <li><a href="../manual/overview.md.html">overview</a></li>
  <li><a href="../manual/scanner.md.html">scanner</a></li>
</ul>
<h2>Protocols</h2>
<ul class="nowrap">
  <li><a href="../protocols/wayland.html">wayland</a></li>
</ul>
<h2>Classes</h2>
<ul class="nowrap">
  <li><a href="../classes/wl_display.html">wl_display</a></li>
  <li><a href="../classes/wl_interface.html">wl_interface</a></li>
  <li><a href="../classes/wl_proxy.html">wl_proxy</a></li>
  <li><a href="../classes/wl_cursor.html">wl_cursor</a></li>
  <li><a href="../classes/wl_cursor_image.html">wl_cursor_image</a></li>
  <li><a href="../classes/wl_cursor_theme.html">wl_cursor_theme</a></li>
</ul>
<h2>Examples</h2>
<ul class="nowrap">
  <li><a href="../examples/foreign_toplevel_manager.lua.html">foreign_toplevel_manager.lua</a></li>
  <li><a href="../examples/layershell.lua.html">layershell.lua</a></li>
  <li><a href="../examples/list_globals.lua.html">list_globals.lua</a></li>
  <li><a href="../examples/toplevel.lua.html">toplevel.lua</a></li>
  <li><a href="../examples/xdg_top.lua.html">xdg_top.lua</a></li>
</ul>

</div>

<div id="content">


<p>If you come from C and you did a little bit of wayland over there, you will find that most things are done very analogous.</p>

<p>Let's take a look at one of the most simple C libwayland examples straight from <a href="https://wayland-book.com/registry/binding.html">the wayland book</a> - listing all globals:</p>


<pre>
#include &lt;stdint.h&gt;
#include &lt;stdio.h&gt;
#include &lt;wayland-client.h&gt;

<span class="keyword">static</span> <span class="keyword">void</span>
<span class="function-name">registry_handle_global</span>(<span class="keyword">void</span> *data, <span class="keyword">struct</span> wl_registry *registry,
        uint32_t name, <span class="keyword">const</span> <span class="keyword">char</span> *interface, uint32_t version)
{
    <span class="function-name">printf</span>(<span class="string">"interface: '%s', version: %d, name: %d\n"</span>,
            interface, version, name);
}

<span class="keyword">static</span> <span class="keyword">void</span>
<span class="function-name">registry_handle_global_remove</span>(<span class="keyword">void</span> *data, <span class="keyword">struct</span> wl_registry *registry,
        uint32_t name)
{
    <span class="comment">// This space deliberately left blank
</span>}

<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct</span> wl_registry_listener
registry_listener = {
    .global = registry_handle_global,
    .global_remove = registry_handle_global_remove,
};

<span class="keyword">int</span>
<span class="function-name">main</span>(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])
{
    <span class="keyword">struct</span> wl_display *display = <span class="function-name">wl_display_connect</span>(NULL);
    <span class="keyword">struct</span> wl_registry *registry = <span class="function-name">wl_display_get_registry</span>(display);
    <span class="function-name">wl_registry_add_listener</span>(registry, &amp;registry_listener, NULL);
    <span class="function-name">wl_display_roundtrip</span>(display);
    <span class="keyword">return</span> <span class="number">0</span>;
}
</pre>


<h1>Direct translation</h1>

<p>How would we achieve that with lua and wau?</p>

<p>First, we will translate the code above as accurately as possible to lua:</p>


<pre>
<span class="keyword">local</span> wau = <span class="global">require</span>(<span class="string">"wau"</span>)

<span class="keyword">local</span> <span class="keyword">function</span> <span class="function-name">registry_handle_global</span>(registry, name, interface, version)
    <span class="global">print</span>(<span class="string">"interface: "</span> .. interface .. <span class="string">", version: "</span> .. <span class="global">tostring</span>(version) .. <span class="string">", name: "</span> .. name)
<span class="keyword">end</span>

<span class="keyword">local</span> <span class="keyword">function</span> <span class="function-name">registry_handle_global_remove</span>(registry, name)
    <span class="comment">-- This space deliberately left blank
</span><span class="keyword">end</span>

<span class="keyword">local</span> registry_listener = {
    [<span class="string">"global"</span>] = registry_handle_global,
    [<span class="string">"global_remove"</span>] = registry_handle_global_remove
}

<span class="keyword">local</span> <span class="keyword">function</span> <span class="function-name">main</span>()
    <span class="keyword">local</span> display = wau.wl_display.<span class="function-name">connect</span>(<span class="keyword">nil</span>)
    <span class="keyword">local</span> registry = wau.wl_display.<span class="function-name">get_registry</span>(display)
    wau.wl_registry.<span class="function-name">add_listener</span>(registry, registry_listener, <span class="keyword">nil</span>)
    wau.wl_display.<span class="function-name">roundtrip</span>(display)
    <span class="keyword">return</span> <span class="number">0</span>
<span class="keyword">end</span>

<span class="function-name">main</span>()
</pre>


<p>That looks overly similar already. What are some differences?</p>

<ul>
    <li>The callbacks don't get a data object handed to them</li>
    <li>Well... that's about it, the rest is about conforming to luas language specifics</li>
</ul>

<h1>"Improvements"</h1>

<p>Now there are some improvements we can make with that program to write more lua-style:</p>

<p><a name="1__Lua_can_emulate_object_oriented_programming"></a></p>
<h2>1. Lua can emulate object-oriented programming</h2>

<p>If we got a wayland interface <code>wl_thing</code>, then all fields that are accessbile through <code>wau.wl_thing[key]</code>, are also accessible by an instance of the interface directly <code>mything[key]</code>. </p>

<p>So instead of doing <code>wau.wl_display.get_registry(display)</code>, we could do <code>display.get_registry(display)</code>. And if you know a little lua already, that is a case where the <code>:</code>-operator comes in handy. It's equivalent to <code>display:get_registry()</code>.</p>


<pre>
    <span class="keyword">local</span> display = wau.wl_display.<span class="function-name">connect</span>(<span class="keyword">nil</span>)
-   <span class="keyword">local</span> registry = wau.wl_display.<span class="function-name">get_registry</span>(display)
+   <span class="keyword">local</span> registry = display:<span class="function-name">get_registry</span>()
-   wau.wl_registry.<span class="function-name">add_listener</span>(registry, registry_listener, <span class="keyword">nil</span>)
+   registry:<span class="function-name">add_listener</span>(registry_listener)
-   wau.wl_display.<span class="function-name">roundtrip</span>(display)
+   display:<span class="function-name">roundtrip</span>()
</pre>


<p><a name="2__Lua_is_more_forgiving"></a></p>
<h2>2. Lua is more forgiving</h2>

<p>As a scripting language, lua let's you write more freely when doing your wayland work. </p>

<p>Take for example the <code>registry_listener</code>. In C, we need them to be <code>static const</code>. But in lua there is no need for them to be declared outside of the function.</p>


<pre>
-   registry:<span class="function-name">add_listener</span>(registry_listener)
+   registry:<span class="function-name">add_listener</span> {
+       [<span class="string">"global"</span>] = registry_handle_global,
+       [<span class="string">"global_remove"</span>] = registry_handle_global_remove
+   }
</pre>


<p>And even there, we can even inline the functions to which we are here referencing, if we really want to (of course there will be cases where it is more convenient to not do so).</p>


<pre>
    registry:<span class="function-name">add_listener</span> {
-       [<span class="string">"global"</span>] = registry_handle_global,
+       [<span class="string">"global"</span>] = <span class="keyword">function</span>(registry, name, interface, version)
+           <span class="global">print</span>(<span class="string">"interface: "</span> .. interface .. <span class="string">", version: "</span> .. <span class="global">tostring</span>(version) .. <span class="string">", name: "</span> .. name)
+       <span class="keyword">end</span>,
-       [<span class="string">"global_remove"</span>] = registry_handle_global_remove
+       [<span class="string">"global_remove"</span>] = <span class="keyword">function</span>(registry, name)
+           <span class="comment">-- This space deliberately left blank
</span>+       <span class="keyword">end</span>
    }
</pre>


<p>And of course, having a <code>main</code> function was more of an exercise in recreating the C code very precisly. We don't need that in lua, it will just start to execute the script starting from the top. So what we end up after all the refactors is the following:</p>


<pre>
<span class="keyword">local</span> wau = <span class="global">require</span>(<span class="string">"wau"</span>)

<span class="keyword">local</span> display = wau.wl_display.<span class="function-name">connect</span>(<span class="keyword">nil</span>)
<span class="keyword">local</span> registry = display:<span class="function-name">get_registry</span>()

registry:<span class="function-name">add_listener</span> {
    [<span class="string">"global"</span>] = <span class="keyword">function</span>(registry, name, interface, version)
        <span class="global">print</span>(<span class="string">"interface: "</span> .. interface .. <span class="string">", version: "</span> .. <span class="global">tostring</span>(version) .. <span class="string">", name: "</span> .. name)
    <span class="keyword">end</span>,
    [<span class="string">"global_remove"</span>] = <span class="keyword">function</span>(registry, name)
        <span class="comment">-- This space deliberately left blank
</span>    <span class="keyword">end</span>
}

display:<span class="function-name">roundtrip</span>()
</pre>




</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/lunarmodules/LDoc">LDoc 1.5.0</a></i>
<i style="float:right;">Last updated 2023-07-28 15:31:50 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
